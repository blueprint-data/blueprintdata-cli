name: Transform Data

on:
  workflow_dispatch:
  workflow_run:
    workflows: ['Extract Data']
    types:
      - completed

jobs:
  transform:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dbt
        run: pipx install dbt-{{STORAGE_TYPE}}

      - name: Create profiles directory
        run: mkdir -p ~/.dbt

      - name: Setup profiles.yml
        working-directory: transform
        run: |
          cp profiles.yml.example ~/.dbt/profiles.yml
          sed -i 's/$DB_HOST/localhost/g' ~/.dbt/profiles.yml
          sed -i 's/$DB_PORT/5432/g' ~/.dbt/profiles.yml
          sed -i 's/$DB_USER/test_user/g' ~/.dbt/profiles.yml
          sed -i 's/$DB_PASSWORD/test_password/g' ~/.dbt/profiles.yml
          sed -i 's/$DB_NAME/test_db/g' ~/.dbt/profiles.yml

      - name: Run dbt tests
        working-directory: transform
        run: dbt test

      - name: Run dbt run
        working-directory: transform
        run: dbt run
